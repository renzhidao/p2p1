<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>å±€åŸŸç½‘èŠå¤©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>
      :root{
        --sidebar-fr: 0.28; --header-fr: 0.10; --send-fr: 0.18;
        --bg: #0e0f13; --panel: #0b0d12; --fg: #e6e6e6; --muted: #9aa7b4; --line: rgba(255,255,255,.08);
        --input-bg: #0a1120; --input-border: #2d3649; --chip: #0d1526; --chip-border: #2e3648; --btn-bg: #1a2234; --btn-border: #354059; --primary: #2a7cff; --thumb: 160px;
      }
      *{ box-sizing: border-box; }
      html, body{
        width:100%; height:100%; margin:0; background: var(--bg); color: var(--fg);
        font-family: ui-sans-serif,-apple-system,system-ui,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",Arial,"Noto Sans","Hiragino Sans GB",sans-serif;
        -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      }
      .shell{ width: 100dvw; height: 100dvh; }
      .app{
        width:100%; height:100%;
        display:grid;
        grid-template-columns: calc(var(--sidebar-fr) * 100%) calc((1 - var(--sidebar-fr)) * 100%);
        grid-template-rows: calc(var(--header-fr) * 100%) calc((1 - var(--header-fr) - var(--send-fr)) * 100%) calc(var(--send-fr) * 100%);
        gap:10px; padding:10px;
      }
      .sidebar{
        grid-column:1; grid-row:1 / span 3;
        background:var(--panel); border:1px solid var(--line); border-radius:12px;
        display:grid; grid-template-rows:auto 1fr; overflow:hidden; min-width:0; min-height:0;
      }
      .sidebar .search{ padding:10px; border-bottom:1px solid var(--line); background:#0c1018; }
      .sidebar .search input{
        width:100%; height:40px; font-size:14px; background:#0f1320; color:#d7e1f2;
        border:1px solid #32394a; border-radius:8px; padding:8px 12px; outline:none;
      }
      .sidebar .list{ padding:10px; overflow:auto; }
      .contact{
        display:grid; grid-template-columns:36px 1fr; gap:8px; align-items:center;
        padding:8px; border:1px solid #232a3a; background:#0e1422; border-radius:10px; margin-bottom:8px; cursor:pointer;
      }
      .contact.active{ border-color:#3b82f6; background:#0d1526; }
      .avatar{ width:36px; height:36px; border-radius:50%; background: linear-gradient(135deg,#5aa1ff,#7ce3ff); }
      .cname{ font-size:13px; color:#cfe3ff; }
      .cmsg{ font-size:12px; color:#8ea0b8; }

      .header{
        grid-column:2; grid-row:1;
        background:var(--panel); border:1px solid var(--line); border-radius:12px;
        display:flex; align-items:center; gap:8px; padding:0 12px; overflow:hidden; min-width:0;
      }
      .chip{ padding:4px 10px; border-radius:999px; font-size:12px; background:var(--chip); border:1px solid var(--chip-border); color:#a9c6ff; white-space:nowrap; }

      .messages{
        grid-column:2; grid-row:2;
        background:var(--panel); border:1px solid var(--line); border-radius:12px;
        padding:10px; display:grid; grid-template-rows:1fr; min-height:0; min-width:0;
      }
      .msg-scroll{ overflow:auto; display:grid; grid-auto-rows:min-content; gap:8px; padding-right:4px; }
      .row{ display:flex; gap:8px; align-items:flex-end; }
      .row.right{ justify-content:flex-end; }
      .bubble{
        max-width:72%; padding:8px 10px; border-radius:12px; font-size:14px; line-height:1.35;
        border:1px solid #2a3142; background:#0f1726; color:#dce8ff; word-break:break-word; min-width:0;
      }
      .bubble.me{ background:#163244; border-color:#23465f; }
      .bubble.file{ background:#0f1c2e; color:#cfe3ff; padding:8px 10px; max-width:280px; }
      .bubble.media{ background:transparent; border:none; padding:0; }
      .file-link{ text-decoration:none; color:inherit; display:block; }
      .file-info{ display:flex; align-items:center; gap:8px; min-width:0; }
      .file-icon{ font-size:24px; flex-shrink:0; }
      .file-name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .progress-line{ margin-top:4px; font-size:12px; color:#8ea0b8; }

      .thumb-link{ display:inline-block; text-decoration:none; }
      .thumb.img{ width: var(--thumb); height:auto; display:block; border-radius:8px; }
      .thumb.video{ position:relative; width:var(--thumb); border-radius:8px; overflow:hidden; background:#0f1726 center/cover no-repeat; }
      .thumb.video::before{ content:''; display:block; padding-top:56.25%; }
      .thumb.video .play{
        position:absolute; inset:0; display:grid; place-items:center;
        color:#fff; font-size:28px; text-shadow:0 3px 12px rgba(0,0,0,.6);
      }

      .avatar-sm{
        width:28px; height:28px; border-radius:50%;
        display:grid; place-items:center; background: linear-gradient(135deg,#5aa1ff,#7ce3ff);
        flex:0 0 28px; overflow:hidden;
      }
      .avatar-sm .letter{ color:#fff; font-weight:700; font-size:12px; user-select:none; line-height:1; }

      .send{
        grid-column:2; grid-row:3;
        background:var(--input-bg); border:1px solid var(--input-border); border-radius:12px;
        display:grid; grid-template-columns:auto 1fr auto; grid-template-rows:1fr auto; min-width:0; min-height:0;
      }
      .editor{
        grid-column:1 / -1; grid-row:1;
        background:transparent; color:#e5efff; line-height:1.35; font-size:14px;
        outline:none; white-space:pre-wrap; word-break:break-word; overflow:auto; padding:10px;
      }
      .editor:empty:before{ content: attr(data-ph); color: var(--muted); pointer-events:none; }
      .s-left{ grid-column:1; grid-row:2; display:flex; gap:10px; align-items:center; padding:10px; }
      .s-actions{ grid-column:3; grid-row:2; display:flex; gap:10px; align-items:center; padding:10px; }
      .icon{
        display:inline-grid; place-items:center; width:38px; height:38px; border-radius:10px;
        background:var(--btn-bg); border:1px solid var(--btn-border); color:#d8e6ff; font-size:18px; cursor:pointer; user-select:none; flex:0 0 38px;
      }
      .icon input[type=file]{ display:none; }
      .btn{ padding:8px 14px; border-radius:10px; background:var(--btn-bg); border:1px solid var(--btn-border); color:#d8e6ff; font-size:14px; cursor:pointer; }
      .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
      .btn[disabled]{ opacity:.45; cursor:not-allowed; }

      .send.drag-over{ outline:2px dashed #2a7cff; outline-offset:-6px; }
      @media (max-width: 380px){
        .bubble{ font-size:13px; }
        .editor{ font-size:13px; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="app">
        <aside class="sidebar" aria-label="è”ç³»äºº">
          <div class="search"><input id="contactSearch" placeholder="æœç´¢è”ç³»äºº" /></div>
          <div class="list" id="contactList"></div>
        </aside>

        <header class="header" aria-label="é¡¶éƒ¨æ ">
          <span class="chip" id="statusChip">æœªè¿æ¥</span>
          <span class="chip" id="onlineChip">åœ¨çº¿ 0</span>
          <span class="chip">èŠå¤©ä¸­</span>
          <span class="chip">å…æ‰“æ‰°</span>
          <span class="chip">ç¾¤è®¾ç½®</span>
        </header>

        <main class="messages" aria-label="æ¶ˆæ¯åˆ—è¡¨">
          <div id="msgScroll" class="msg-scroll"></div>
        </main>

        <section class="send" aria-label="å‘é€åŒº" id="sendArea">
          <div id="editor" class="editor" contenteditable="true" data-ph="è¾“å…¥æ¶ˆæ¯â€¦ å›è½¦å‘é€ï¼ŒShift+Enter æ¢è¡Œ"></div>
          <div class="s-left">
            <button id="emojiBtn" class="icon" title="è¡¨æƒ…">ğŸ˜€</button>
            <label class="icon" title="é™„ä»¶">ğŸ“<input id="fileInput" type="file" multiple /></label>
          </div>
          <div class="s-actions"><button id="sendBtn" class="btn primary" disabled>å‘é€</button></div>
        </section>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
    <script>
      // âœ… ä¿®å¤ï¼šå»æ‰åŒä¸‹åˆ’çº¿ï¼Œä¸ easytier.js ä¸­çš„æ£€æŸ¥ä¿æŒä¸€è‡´
      window.CLASSIC_UI = true;
    </script>
    <script src="easytier.js"></script>
  </body>
</html>
```

---

## ğŸ“„ easytier.jsï¼ˆä¿æŒä¸å˜ï¼Œç¡®ä¿å˜é‡åä¸€è‡´ï¼‰

```javascript
(function(){
var injectedServer  = (typeof window.__FIXED_SERVER__  === 'object' && window.__FIXED_SERVER__)  || null;
var injectedNetwork = (typeof window.__FIXED_NETWORK__ === 'string' && window.__FIXED_NETWORK__) || null;

var ICE = [
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'},
  {urls:'stun:global.stun.twilio.com:3478'}
];
var CHUNK = 512*1024;
var PREVIEW_PCT = 3;
var HIGH_WATER  = 1.5*1024*1024;
var LOW_WATER   = 0.6*1024*1024;

function now(){ return new Date().toLocaleTimeString(); }
function shortId(id){ return id? id.substr(0,10)+'...':'-'; }
function human(n){
  if(n<1024) return n+' B';
  if(n<1024*1024) return (n/1024).toFixed(1)+' KB';
  if(n<1024*1024*1024) return (n/1024/1024).toFixed(1)+' MB';
  return (n/1024/1024/1024).toFixed(1)+' GB';
}
function genIp(id){
  var h=0; for(var i=0;i<id.length;i++){ h=(h*31+id.charCodeAt(i))>>>0; }
  return '10.144.'+(((h)&0xff)+1)+'.'+(((h>>8)&0xff)+1);
}
function getPeerParam(){
  var s=window.location.search; if(!s||s.length<2) return '';
  var m=s.match(/[?&]peer=([^&]+)/); return m? decodeURIComponent(m[1]):'';
}
function sha256(str){
  var enc=new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-256', enc).then(function(buf){
    var b=new Uint8Array(buf), s=''; for(var i=0;i<b.length;i++){ s+=('0'+b[i].toString(16)).slice(-2); }
    return s;
  });
}
function fileHashMeta(file){ return sha256(file.name+'|'+file.size); }

var idb, idbReady=false;
(function openIDB(){
  try{
    var req=indexedDB.open('p2p-cache',2);
    req.onupgradeneeded=function(e){
      var db=e.target.result;
      if(!db.objectStoreNames.contains('files')) db.createObjectStore('files',{keyPath:'hash'});
      if(!db.objectStoreNames.contains('parts')) db.createObjectStore('parts',{keyPath:'hash'});
    };
    req.onsuccess=function(e){ idb=e.target.result; idbReady=true; };
    req.onerror=function(){ idbReady=false; };
  }catch(e){ idbReady=false; }
})();
function idbPutFull(hash, blob, meta){
  if(!idbReady) return;
  try{ var tx=idb.transaction('files','readwrite'); tx.objectStore('files').put({hash:hash, blob:blob, meta:meta, ts:Date.now()}); }catch(e){}
}
function idbGetFull(hash, cb){
  if(!idbReady) return cb(null);
  try{
    var tx=idb.transaction('files','readonly'); var rq=tx.objectStore('files').get(hash);
    rq.onsuccess=function(){ cb(rq.result||null); }; rq.onerror=function(){ cb(null); };
  }catch(e){ cb(null); }
}
function idbPutPart(hash, meta){
  if(!idbReady) return;
  try{ var tx=idb.transaction('parts','readwrite'); tx.objectStore('parts').put({hash:hash, meta:meta, ts:Date.now()}); }catch(e){}
}
function idbGetPart(hash, cb){
  if(!idbReady) return cb(null);
  try{
    var tx=idb.transaction('parts','readonly'); var rq=tx.objectStore('parts').get(hash);
    rq.onsuccess=function(){ cb(rq.result||null); }; rq.onerror=function(){ cb(null); };
  }catch(e){ cb(null); }
}
function idbDelPart(hash){
  if(!idbReady) return;
  try{ var tx=idb.transaction('parts','readwrite'); tx.objectStore('parts').delete(hash); }catch(e){}
}

function extractVideoThumbnail(file, cb){
  var video=document.createElement('video');
  video.preload='metadata'; video.muted=true; video.playsInline=true;
  var url=URL.createObjectURL(file);
  var cleaned=false, clean=function(){ if(cleaned) return; cleaned=true; try{URL.revokeObjectURL(url);}catch(e){} };
  video.src=url;
  video.addEventListener('loadeddata', function(){
    try{ video.currentTime = Math.min(1, (video.duration||1)*0.1); }catch(e){ clean(); cb(null); }
  }, {once:true});
  video.addEventListener('seeked', function(){
    try{
      var w=video.videoWidth||320, h=video.videoHeight||180, r=w/h, W=320, H=Math.round(W/r);
      var c=document.createElement('canvas'); c.width=W; c.height=H;
      var g=c.getContext('2d'); g.drawImage(video,0,0,W,H);
      var poster=c.toDataURL('image/jpeg',0.7);
      clean(); cb(poster);
    }catch(e){ clean(); cb(null); }
  }, {once:true});
  video.addEventListener('error', function(){ clean(); cb(null); }, {once:true});
}

var app=(function(){
  var self={};

  self.server  = injectedServer || {host:'peerjs.92k.de', port:443, secure:true, path:'/'};
  self.network = injectedNetwork || 'public-network';

  self.chunkSize  = CHUNK;
  self.previewPct = PREVIEW_PCT;
  self.highWater  = HIGH_WATER;
  self.lowWater   = LOW_WATER;

  self.iceServers = ICE;

  self.peer=null; self.conns={}; self.isConnected=false; self.startAt=0;
  self.localId=''; self.virtualIp='';
  self.timers={up:null,ping:null};

  // ç²¾ç®€æ˜¾ç¤º + å…¨é‡å¤åˆ¶
  self.logBuf='> åˆå§‹åŒ–ï¼šå‡†å¤‡è¿æ¥';
  self.logFullBuf=self.logBuf;

  self.fullSources={};
  self.displayNames={};
  self.activePeer='all';
  self.myName = (localStorage.getItem('nickname')||'').trim() || '';

  function isImportant(s){
    var t=String(s||'');
    return /å·²è¿æ¥|æ–­å¼€|é”™è¯¯|æ‹¨å·|å…¥ç«™|æ¶ˆæ¯|æ–‡ä»¶|å¼€å§‹è¿æ¥|è¿æ¥è¶…æ—¶|è¿æ¥å·²å…³é—­|å‘é€|æ¥æ”¶|é€šè¯/.test(t);
  }
  function log(s){
    var line="["+now()+"] "+s;
    self.logFullBuf += "\n"+line;
    if (isImportant(s)){
      self.logBuf += "\n"+line;
      var el=document.getElementById('log');
      if(el){ el.textContent=self.logBuf; el.scrollTop=el.scrollHeight; }
    }
    if (typeof window.updateEntryStatus === 'function'){
      var up='00:00:00';
      if(self.isConnected && self.startAt){
        var sec=Math.floor((Date.now()-self.startAt)/1000), h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s2=sec%60;
        up=(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(s2<10?'0':'')+s2;
      }
      window.updateEntryStatus({
        connected:self.isConnected,
        online:Object.keys(self.conns).filter(k=>self.conns[k].open).length,
        localId:self.localId, virtualIp:self.virtualIp, uptime:up
      });
    }
  }
  self.log = log;

  self.copyLog=function(){
    try{
      var txt=self.logFullBuf||'';
      if(navigator.clipboard&&navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).then(function(){ alert('å·²å¤åˆ¶å…¨éƒ¨æ—¥å¿—'); });
      }else{
        var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('å·²å¤åˆ¶å…¨éƒ¨æ—¥å¿—');
      }
    }catch(e){ alert('å¤åˆ¶å¤±è´¥ï¼š'+e.message); }
  };
  self.clearLog=function(){ self.logBuf=''; self.logFullBuf=''; var el=document.getElementById('log'); if(el) el.textContent=''; };

  function setStatus(txt){
    var st=document.getElementById('statusChip');
    if(st) st.textContent = 'çŠ¶æ€ï¼š' + txt;
  }

  self.updateInfo=function(){
    var openCount=0; for(var k in self.conns){ if(self.conns[k].open) openCount++; }
    var lid=document.getElementById('localId'),
        vip=document.getElementById('virtualIp'),
        pc=document.getElementById('peerCount');
    if(lid) lid.textContent = self.localId ? shortId(self.localId) : '-';
    if(vip) vip.textContent = self.virtualIp || '-';
    if(pc)  pc.textContent  = String(openCount);
    var onlineChip=document.getElementById('onlineChip');
    if(onlineChip) onlineChip.textContent='åœ¨çº¿ '+openCount;
    if(self._classic && typeof self._classic.updateStatus==='function') self._classic.updateStatus();
  };

  self.showShare=function(){
    var base=window.location.origin+window.location.pathname;
    var url = base + '?peer='+encodeURIComponent(self.localId);
    var input=document.getElementById('shareLink'),
        qr=document.getElementById('qr');
    if(input) input.value=url;
    if(qr){
      qr.innerHTML='';
      new QRCode(qr,{text:url,width:256,height:256,correctLevel:QRCode.CorrectLevel.M});
    }
    var share=document.getElementById('share'); if(share) share.style.display='block';
  };
  self.copyLink=function(){
    var el=document.getElementById('shareLink'); if(!el) return;
    try{
      if(navigator.clipboard&&navigator.clipboard.writeText){
        navigator.clipboard.writeText(el.value).then(function(){ alert('å·²å¤åˆ¶'); });
      } else { el.select(); document.execCommand('copy'); alert('å·²å¤åˆ¶'); }
    }catch(e){ alert('å¤åˆ¶å¤±è´¥ï¼š'+e.message); }
  };

  function pushChat(text,mine){
    if(self._classic && typeof self._classic.appendChat==='function') self._classic.appendChat(text,mine);
  }
  function placeholder(name,size,mine){
    return self._classic && typeof self._classic.placeholder==='function' ? self._classic.placeholder(name,size,mine) : null;
  }
  function showImg(ui,url){ if(self._classic && typeof self._classic.showImage==='function') self._classic.showImage(ui,url); }
  function showVid(ui,url,note){ if(self._classic && typeof self._classic.showVideo==='function') self._classic.showVideo(ui,url,note,null); }
  function fileLink(ui,url,name,size){ if(self._classic && typeof self._classic.showFileLink==='function') self._classic.showFileLink(ui,url,name,size); }
  function updProg(ui,p){ if(self._classic && typeof self._classic.updateProgress==='function') self._classic.updateProgress(ui,p); }

  // æ”¯æŒ classic çš„ editorï¼›ç¾¤å‘/å•èŠ
  self.sendMsg=function(){
    var val='';
    if (self._classic && typeof self._classic.getEditorText==='function') val=self._classic.getEditorText();
    val = (val||'').trim();
    if (!val){ self.log('T14 OUT_ERROR: empty message'); return; }

    pushChat(val, true);
    if (self._classic && typeof self._classic.clearEditor==='function') self._classic.clearEditor();

    var targets=[];
    if (self.activePeer==='all'){
      for (var k in self.conns){ if(self.conns.hasOwnProperty(k) && self.conns[k].open) targets.push(k); }
    }else{
      if (self.conns[self.activePeer] && self.conns[self.activePeer].open) targets=[self.activePeer];
    }
    if (!targets.length){ self.log('T14 OUT_ERROR: no open peers to send'); return; }

    targets.forEach(function(pid){
      try{ self.conns[pid].conn.send({type:'chat', text:val}); }
      catch(e){ self.log('T14 OUT_ERROR: chat send '+(e.message||e)); }
    });
    self.log('T40 CHAT_SENT: '+ (val.length>30? (val.slice(0,30)+'â€¦') : val) +' -> '+targets.length);
  };

  self.sendFiles=function(){
    var fi=document.getElementById('fileInput');
    if(!fi||!fi.files||fi.files.length===0){ alert('è¯·é€‰æ‹©æ–‡ä»¶'); return; }
    self.sendFilesFrom([].slice.call(fi.files)); fi.value='';
  };
  self.sendFilesFrom=function(files){
    var targets=[];
    if (self.activePeer==='all'){
      for(var k in self.conns){ if(self.conns[k].open) targets.push(k); }
    } else {
      if (self.conns[self.activePeer] && self.conns[self.activePeer].open) targets=[self.activePeer];
    }
    if(!targets.length){ self.log('T40 FILE_SEND_BEGIN: no peers open'); alert('æ²¡æœ‰åœ¨çº¿èŠ‚ç‚¹ï¼Œæ— æ³•å‘é€æ–‡ä»¶'); return; }

    files.forEach(function(file){
      var ui = placeholder(file.name, file.size, true);
      var localUrl = URL.createObjectURL(file);
      if ((file.type||'').indexOf('image/')===0) showImg(ui, localUrl);
      else if ((file.type||'').indexOf('video/')===0){
        extractVideoThumbnail(file, function(p){ if (ui) ui.poster=p; showVid(ui, localUrl, 'å·²å‘é€'); });
      } else { fileLink(ui, localUrl, file.name, file.size); }
      setTimeout(function(){ try{URL.revokeObjectURL(localUrl);}catch(e){} },60000);

      fileHashMeta(file).then(function(hash){
        targets.forEach(function(pid){ enqueueFile(pid,file,hash); });
      });
    });
  };

  function enqueueFile(pid,file,hash){
    var st=self.conns[pid]; if(!st||!st.open){ self.log('å¯¹æ–¹ä¸åœ¨çº¿ï¼š'+shortId(pid)); return; }
    if(!st.queue) st.queue=[];
    st.queue.push({file:file,hash:hash});
    if(!st.sending){ st.sending=true; sendNext(pid); }
  }
  function sendNext(pid){
    var st=self.conns[pid]; if(!st) return;
    var job=st.queue.shift(); if(!job){ st.sending=false; return; }
    sendFileTo(pid, job.file, job.hash, function(){ sendNext(pid); });
  }
  function getBuffered(c){
    try{
      if(c&&c._dc&&typeof c._dc.bufferedAmount==='number') return c._dc.bufferedAmount;
      if(c&&typeof c.bufferSize==='number') return c.bufferSize;
    }catch(e){}
    return 0;
  }
  function flowSend(c,data,cb){
    var loop=function(){
      if(getBuffered(c)>HIGH_WATER){ setTimeout(loop,20); return; }
      try{ c.send(data);}catch(e){ cb(e); return; }
      cb(null);
    };
    loop();
  }

  function sendFileTo(pid,file,hash,done){
    var st=self.conns[pid]; if(!st||!st.open){ self.log('å¯¹æ–¹ä¸åœ¨çº¿ï¼š'+shortId(pid)); return done&&done(); }

    var c=st.conn,
        id=String(Date.now())+'_'+Math.floor(Math.random()*1e6),
        chunk=self.chunkSize,
        state={off:0},
        lastTs=0, lastPct=-1;

    var posterP = (file.type||'').indexOf('video/')===0 ? new Promise(function(r){ extractVideoThumbnail(file,r); }) : Promise.resolve(null);

    posterP.then(function(poster){
      try{
        c.send({type:'file-begin', id:id, name:file.name, size:file.size, mime:file.type||'application/octet-stream', chunk:chunk, hash:hash, poster:poster||null});
      }catch(e){ self.log('æ–‡ä»¶å…ƒä¿¡æ¯å‘é€å¤±è´¥'); return done&&done(); }

      st._curSend = st._curSend || {};
      st._curSend[id] = { setOffset:function(n){ state.off = Math.max(0, Math.min(file.size, n|0)); } };

      var reader=new FileReader();
      reader.onerror=function(){ self.log('æ–‡ä»¶è¯»å–å¤±è´¥'); try{ c.send({type:'file-end', id:id, hash:hash}); }catch(e){} done&&done(); };
      reader.onload=function(e){
        flowSend(c,e.target.result,function(err){
          if(err){ self.log('æ•°æ®å‘é€å¤±è´¥'); delete st._curSend[id]; return done&&done(); }
          state.off += e.target.result.byteLength;
          var pct=Math.min(100,Math.floor(state.off*100/file.size));
          var nowTs=Date.now();
          if(pct!==lastPct && (nowTs-lastTs>300 || pct===100)){ lastTs=nowTs; lastPct=pct; }
          if(state.off<file.size){ setTimeout(readNext,0); }
          else { try{ c.send({type:'file-end', id:id, hash:hash}); }catch(e){} delete st._curSend[id]; done&&done(); }
        });
      };
      function readNext(){
        var slice=file.slice(state.off,Math.min(state.off+chunk,file.size));
        reader.readAsArrayBuffer(slice);
      }
      readNext();
    });
  }

  self.toggle=function(){
    if(self.isConnected){ self.disconnect(); return; }
    var nameEl=document.getElementById('networkName');
    if(nameEl && nameEl.value.trim()) self.network=nameEl.value.trim();
    var nick = (localStorage.getItem('nickname')||'').trim();
    self.myName = nick || ('ç”¨æˆ·-'+Math.random().toString(36).slice(2,6));
    connect();
  };

  function connect(){
    setStatus('è¿æ¥ä¸­â€¦'); self.log('å¼€å§‹è¿æ¥â€¦');
    try{
      var p=new Peer(null,{host:self.server.host,port:self.server.port,secure:self.server.secure,path:self.server.path,config:{iceServers:self.iceServers}});
      self.peer=p;
    }catch(e){ self.log('åˆå§‹åŒ–å¤±è´¥ï¼š'+e.message); setStatus('ç¦»çº¿'); return; }

    var opened=false;
    var t=setTimeout(function(){ if(!opened){ self.log('è¿æ¥è¶…æ—¶'); try{ self.peer.destroy(); }catch(e){} setStatus('ç¦»çº¿'); } }, 10000);

    self.peer.on('open', function(id){
      opened=true; clearTimeout(t);
      self.localId=id; self.virtualIp=genIp(id); self.isConnected=true; self.startAt=Date.now();
      setStatus('åœ¨çº¿');
      self.updateInfo();
      self.showShare();
      self.log('å·²è¿æ¥ï¼ŒID='+id);

      var toDial=getPeerParam();
      if(toDial){ self.log('å‡†å¤‡è¿æ¥å¯¹ç«¯ï¼š'+toDial); setTimeout(function(){ connectPeer(toDial); },400); }

      startTimers();
    });

    self.peer.on('connection', function(conn){ handleConn(conn,true); });
    self.peer.on('error', function(err){ self.log('è¿æ¥é”™è¯¯ï¼š'+(err && (err.message||err.type)||err)); });
    self.peer.on('disconnected', function(){ self.log('ä¿¡ä»¤æ‰çº¿ï¼Œå°è¯•é‡è¿'); try{ self.peer.reconnect(); }catch(e){} });
    self.peer.on('close', function(){ self.log('è¿æ¥å·²å…³é—­'); });

    self.peer.on('call', function(call){
      if (!window.__ENTRY_PAGE__){ try{ call.close(); }catch(e){} return; }
      navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(stream){
        self._media = self._media || {};
        self._media.local = stream;
        var lv=document.getElementById('localVideo'); if(lv) lv.srcObject=stream;
        call.answer(stream);
        self._media.call = call;
        call.on('stream', function(remote){ var rv=document.getElementById('remoteVideo'); if(rv) rv.srcObject=remote; });
        call.on('close', function(){ self.toggleCall(true); });
        call.on('error', function(){ self.toggleCall(true); });
      }).catch(function(){ try{ call.close(); }catch(e){} });
    });
  }

  function connectPeer(pid){
    if(!self.peer || !pid || pid===self.localId) return;
    if(self.conns[pid] && self.conns[pid].open) return;
    self.log('æ‹¨å·ï¼š'+pid);
    var c;
    try{ c=self.peer.connect(pid,{reliable:true}); }
    catch(e){ self.log('æ‹¨å·å¤±è´¥ï¼š'+(e.message||e)); return; }
    handleConn(c,false);
    setTimeout(function(){
      var st=self.conns[pid];
      if(!st||!st.open){
        try{ c.close(); }catch(e){}
        self.log('å¯¹ç«¯æœªå“åº”ï¼š'+shortId(pid));
      }
    },12000);
  }

  function handleConn(c,inbound){
    if(!c||!c.peer) return;
    var pid=c.peer;
    if(self.conns[pid] && self.conns[pid].open){
      try{ c.close(); }catch(e){}
      return;
    }
    if(!self.conns[pid]) {
      self.conns[pid]={ conn:c, open:false, latency:0, sending:false, queue:[], recv:{cur:null,ui:null}, _curSend:{} };
    }

    if(inbound) self.log('æ”¶åˆ°å…¥ç«™è¿æ¥ï¼š'+shortId(pid));

    c.on('open', function(){
      self.conns[pid].open=true;
      self.updateInfo();
      try{
        c.send({
          type:'hello',
          id:self.localId,
          name:self.myName,
          ip:self.virtualIp,
          network:self.network,
          fullList:Object.keys(self.fullSources)
        });
      }catch(e){}
      if(self._classic && self._classic.renderContacts){
        var arr=[]; for(var k in self.conns){ if(self.conns[k].open) arr.push({id:k,name:self.displayNames[k]||('èŠ‚ç‚¹ '+shortId(k))}); }
        self._classic.renderContacts(arr, self.activePeer);
      }
    });

    c.on('data', function(d){
      if(d && typeof d==='object' && d.type){
        if(d.type==='hello'){
          self.displayNames[pid] = d.name || ('èŠ‚ç‚¹ '+shortId(pid));
          if (d.fullList && Array.isArray(d.fullList)){
            d.fullList.forEach(function(h){
              self.fullSources[h]=self.fullSources[h]||new Set();
              self.fullSources[h].add(pid);
            });
          }
          if(self._classic && self._classic.renderContacts){
            var arr=[]; for(var k in self.conns){ if(self.conns[k].open) arr.push({id:k,name:self.displayNames[k]||('èŠ‚ç‚¹ '+shortId(k))}); }
            self._classic.renderContacts(arr, self.activePeer);
          }
        }
        else if(d.type==='ping'){
          if(self.conns[pid].open){ try{ c.send({type:'pong',ts:d.ts}); }catch(e){} }
        }
        else if(d.type==='pong'){
          var lat=Date.now()-(d.ts||Date.now());
          self.conns[pid].latency=lat;
          self.log('å»¶è¿Ÿï¼š'+lat+'ms');
          self.updateInfo();
        }
        else if(d.type==='chat'){
          pushChat(String(d.text||''), false);
          self.log('æ”¶åˆ°æ¶ˆæ¯');
        }
        else if(d.type==='file-begin'){
          var h=d.hash||'';
          var ui=placeholder(d.name||'æ–‡ä»¶', d.size||0, false);
          if ((d.mime||'').indexOf('video/')===0 && d.poster){ ui.poster = d.poster; showVid(ui,'#','ç­‰å¾…æ•°æ®â€¦'); }

          if(h){
            idbGetFull(h, function(rec){
              if(rec && rec.blob){
                var url=URL.createObjectURL(rec.blob);
                if ((rec.meta && rec.meta.mime || '').indexOf('image/')===0) showImg(ui,url);
                else if ((rec.meta && rec.meta.mime || '').indexOf('video/')===0) showVid(ui,url,'æœ¬åœ°ç¼“å­˜');
                else fileLink(ui,url, (rec.meta && rec.meta.name)||d.name||'æ–‡ä»¶', (rec.meta && rec.meta.size)||d.size||0);
                setTimeout(function(){ try{URL.revokeObjectURL(url);}catch(e){} },60000);
                try{ c.send({type:'file-end',id:d.id,hash:h}); }catch(e){}
                return;
              }
              idbGetPart(h, function(rec2){
                if(rec2 && rec2.meta && typeof rec2.meta.got==='number' && rec2.meta.got<(d.size||0)){
                  try{ c.send({type:'file-resume', id:d.id, hash:h, offset:rec2.meta.got}); }catch(e){}
                }
              });
            });
          }

          self.conns[pid].recv.cur={
            id:d.id, name:d.name, size:d.size||0, mime:d.mime||'application/octet-stream',
            got:0, parts:[], previewed:false, previewUrl:null, videoState:null, hash:h
          };
          self.conns[pid].recv.ui=ui;
        }
        else if(d.type==='file-end'){
          finalizeReceive(pid,d.id,d.hash||'');
        }
        else if(d.type==='file-has'){
          var h2=d.hash;
          if(h2){
            self.fullSources[h2]=self.fullSources[h2]||new Set();
            self.fullSources[h2].add(pid);
          }
        }
        else if(d.type==='file-resume'){
          var st=self.conns[pid];
          if (st && st._curSend && st._curSend[d.id] && typeof d.offset==='number'){
            try{ st._curSend[d.id].setOffset(d.offset|0); }catch(e){}
          }
        }
        return;
      }

      var st=self.conns[pid],
          ctx=st&&st.recv&&st.recv.cur,
          ui=st&&st.recv&&st.recv.ui;
      if(!ctx) return;

      var sz=0;
      if(d && d.byteLength!==undefined){ sz=d.byteLength; ctx.parts.push(new Blob([d])); }
      else if(d && d.size!==undefined){ sz=d.size; ctx.parts.push(d); }
      ctx.got+=sz;
      var pct=ctx.size?Math.min(100,Math.floor(ctx.got*100/ctx.size)):0;
      updProg(ui,pct);

      if(ctx.hash && ctx.got>0 && (ctx.got % (2*1024*1024) < sz)){
        try{ idbPutPart(ctx.hash,{name:ctx.name,size:ctx.size,mime:ctx.mime, got:ctx.got}); }catch(e){}
      }

      if(!ctx.previewed){
        try{
          var url=URL.createObjectURL(new Blob(ctx.parts,{type:ctx.mime}));
          if ((ctx.mime||'').indexOf('image/')===0){
            showImg(ui,url); ctx.previewed=true; ctx.previewUrl=url;
          }else if ((ctx.mime||'').indexOf('video/')===0){
            var need=Math.max(1,Math.floor(ctx.size*self.previewPct/100));
            if(ctx.got>=need){ showVid(ui,url,'å¯é¢„è§ˆï¼ˆæ¥æ”¶ä¸­ '+pct+'%ï¼‰'); ctx.previewed=true; ctx.previewUrl=url; }
            else { try{ URL.revokeObjectURL(url);}catch(e){} }
          }
        }catch(e){}
      }
    });

    c.on('close', function(){
      delete self.conns[pid];
      self.updateInfo();
      if(self._classic && self._classic.renderContacts){
        var arr=[]; for(var k in self.conns){ if(self.conns[k].open) arr.push({id:k,name:self.displayNames[k]||('èŠ‚ç‚¹ '+shortId(k))}); }
        self._classic.renderContacts(arr, self.activePeer);
      }
    });

    c.on('error', function(err){ /* å¿½ç•¥ */ });
  }

  function finalizeReceive(pid,id,hash){
    var st=self.conns[pid]; if(!st||!st.recv) return;
    var ctx=st.recv.cur, ui=st.recv.ui;
    if(!ctx||ctx.id!==id) return;

    var blob=new Blob(ctx.parts,{type:ctx.mime});
    var url=URL.createObjectURL(blob);

    if ((ctx.mime||'').indexOf('image/')===0) showImg(ui,url);
    else if ((ctx.mime||'').indexOf('video/')===0) showVid(ui,url,'æ¥æ”¶å®Œæˆ');
    else fileLink(ui,url,ctx.name,ctx.size);

    try{
      idbPutFull(hash||ctx.hash||'', blob, {name:ctx.name,size:ctx.size,mime:ctx.mime});
      if (ctx.hash) idbDelPart(ctx.hash);
      self.fullSources[hash||ctx.hash||'']=self.fullSources[hash||ctx.hash||'']||new Set();
      self.fullSources[hash||ctx.hash||''].add(self.localId);
      for(var k in self.conns){
        var s=self.conns[k]; if(s.open){ try{ s.conn.send({type:'file-has', hash:(hash||ctx.hash||'')}); }catch(e){} }
      }
    }catch(e){}

    try{ if(ctx.previewUrl) URL.revokeObjectURL(ctx.previewUrl);}catch(e){}
    (function(u){ setTimeout(function(){ try{URL.revokeObjectURL(u);}catch(e){} },60000); })(url);
    st.recv.cur=null; st.recv.ui=null;
    self.log('å·²æ¥æ”¶æ–‡ä»¶ï¼š'+ctx.name+' '+human(ctx.size));
  }

  function startTimers(){
    stopTimers();
    self.timers.up=setInterval(function(){
      if(!self.isConnected||!self.startAt) return;
      var s=Math.floor((Date.now()-self.startAt)/1000),
          h=Math.floor(s/3600),
          m=Math.floor((s%3600)/60),
          sec=s%60;
      var t=(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(sec<10?'0':'')+sec;
      var up=document.getElementById('uptime'); if(up) up.textContent=t;
      if (typeof window.updateEntryStatus === 'function'){
        window.updateEntryStatus({connected:true, online:Object.keys(self.conns).filter(k=>self.conns[k].open).length, localId:self.localId, virtualIp:self.virtualIp, uptime:t});
      }
    },1000);

    self.timers.ping=setInterval(function(){
      for(var k in self.conns){
        var st=self.conns[k]; if(!st.open) continue;
        try{ st.conn.send({type:'ping',ts:Date.now()}); }catch(e){}
      }
    },5000);
  }
  function stopTimers(){
    if(self.timers.up){clearInterval(self.timers.up); self.timers.up=null;}
    if(self.timers.ping){clearInterval(self.timers.ping); self.timers.ping=null;}
  }

  self.disconnect=function(){
    for(var k in self.conns){ try{ self.conns[k].conn.close(); }catch(e){} }
    self.conns={}; self.fullSources={};
    if(self.peer){ try{ self.peer.destroy(); }catch(e){} self.peer=null; }
    self.isConnected=false; self.startAt=0; self.localId=''; self.virtualIp='';
    setStatus('ç¦»çº¿'); self.updateInfo();
    stopTimers();
    self.log('å·²æ–­å¼€');
  };

  // å…¥å£é¡µä¸€é”®è§†é¢‘
  self.quickCall=function(){
    if (!self.peer || !self.isConnected){ alert('æœªè¿æ¥'); return; }
    var open = Object.keys(self.conns).filter(function(k){ return self.conns[k] && self.conns[k].open; });
    if (!open.length){ alert('æ²¡æœ‰åœ¨çº¿å¯¹è±¡'); return; }
    var pid = (self.activePeer && self.activePeer!=='all' && self.conns[self.activePeer] && self.conns[self.activePeer].open)
              ? self.activePeer
              : (open.length===1 ? open[0] : null);
    if (!pid && open.length>1){
      var names = open.map(function(k,i){ return (i+1)+'. '+(self.displayNames[k]||('èŠ‚ç‚¹ '+k.slice(0,8))); }).join('\n');
      var ans = prompt('é€‰æ‹©è§†é¢‘é€šè¯å¯¹è±¡ï¼šè¾“å…¥åºå·\n'+names, '1');
      var idx = parseInt(ans||'',10);
      if (idx>=1 && idx<=open.length) pid = open[idx-1];
    }
    if (!pid){ return; }
    self.activePeer = pid;
    self.toggleCall(false);
  };

  self.toggleCall=function(forceClose){
    if (!window.__ENTRY_PAGE__) return;
    self._media = self._media || {};
    if (self._media.call || forceClose){
      try{ self._media.call && self._media.call.close(); }catch(e){}
      if (self._media.local){ try{ self._media.local.getTracks().forEach(t=>t.stop()); }catch(e){} }
      self._media.call=null; self._media.local=null;
      var rv=document.getElementById('remoteVideo'); if(rv) rv.srcObject=null;
      var lv=document.getElementById('localVideo');  if(lv) lv.srcObject=null;
      return;
    }
    var pid=self.activePeer;
    if(!pid || pid==='all'){ alert('è¯·å…ˆé€‰æ‹©é€šè¯å¯¹è±¡'); return; }
    if(!self.peer){ alert('æœªè¿æ¥'); return; }
    navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(function(stream){
      self._media.local=stream;
      var lv=document.getElementById('localVideo'); if(lv) lv.srcObject=stream;
      var call=self.peer.call(pid, stream);
      self._media.call=call;
      call.on('stream', function(remote){ var rv=document.getElementById('remoteVideo'); if(rv) rv.srcObject=remote; });
      call.on('close', function(){ self.toggleCall(true); });
      call.on('error', function(){ self.toggleCall(true); });
    }).catch(function(){ alert('æ— æ³•è·å–æ‘„åƒå¤´/éº¦å…‹é£'); });
  };

  bindClassicUI(self);
  return self;
})();

function bindClassicUI(app){
  if (!window.CLASSIC_UI) return;  // âœ… ç°åœ¨åŒ¹é… classic.html ä¸­çš„å˜é‡å

  var editor = document.getElementById('editor');
  var sendBtn = document.getElementById('sendBtn');
  var fileInput = document.getElementById('fileInput');
  var msgScroll = document.getElementById('msgScroll');
  var contactList = document.getElementById('contactList');
  var contactSearch = document.getElementById('contactSearch');
  var sendArea = document.getElementById('sendArea');
  var statusChip = document.getElementById('statusChip');
  var onlineChip = document.getElementById('onlineChip');

  function textOfEditor(){
    if (!editor) return '';
    var t = editor.innerText || editor.textContent || '';
    return t.replace(/\u00A0/g,' ').replace(/\r/g,'').trim();
  }
  function clearEditor(){ if(editor){ editor.innerHTML=''; editor.textContent=''; } }
  function syncSendBtn(){
    if (!sendBtn) return;
    var hasText = textOfEditor().length>0;
    sendBtn.disabled = !(app && app.isConnected && hasText);
  }

  function fixAllLabel(){
    try{
      var rows = contactList.querySelectorAll('.contact');
      if (rows && rows[0]){
        var nm = rows[0].querySelector('.cname');
        if (nm) nm.textContent = 'æ‰€æœ‰äººï¼ˆç¾¤èŠï¼‰';
      }
    }catch(e){}
  }

  app._classic = {
    appendChat: function(text, mine){
      if (!msgScroll) return;
      var row=document.createElement('div'); row.className='row'+(mine?' right':'');
      var av=document.createElement('div'); av.className='avatar-sm';
      var lt=document.createElement('span'); lt.className='letter'; lt.textContent = mine ? 'æˆ‘' : 'ä»–';
      av.appendChild(lt);
      var bubble=document.createElement('div'); bubble.className='bubble'+(mine?' me':''); bubble.textContent=String(text||'');
      if (mine){ row.appendChild(bubble); row.appendChild(av); } else { row.appendChild(av); row.appendChild(bubble); }
      msgScroll.appendChild(row); msgScroll.scrollTop = msgScroll.scrollHeight;
    },
    placeholder: function(name,size,mine){
      if(!msgScroll) return null;
      var row=document.createElement('div'); row.className='row'+(mine?' right':'');
      var av=document.createElement('div'); av.className='avatar-sm';
      var lt=document.createElement('span'); lt.className='letter'; lt.textContent = mine ? 'æˆ‘' : 'ä»–';
      av.appendChild(lt);
      var bubble=document.createElement('div'); bubble.className='bubble file'+(mine?' me':'');
      var safe = String(name||'æ–‡ä»¶').replace(/"/g,'&quot;');
      bubble.innerHTML = '<div class="file-link"><div class="file-info"><span class="file-icon">ğŸ“„</span>'
                       + '<span class="file-name" title="'+safe+'">'+safe+'</span></div>'
                       + '<div class="progress-line">å‡†å¤‡æ¥æ”¶â€¦</div></div>';
      if (mine){ row.appendChild(bubble); row.appendChild(av); } else { row.appendChild(av); row.appendChild(bubble); }
      msgScroll.appendChild(row); msgScroll.scrollTop=msgScroll.scrollHeight;
      return {root:row, progress:bubble.querySelector('.progress-line'), mediaWrap:bubble};
    },
    showImage: function(ui,url){
      if(!ui||!ui.mediaWrap) return;
      ui.mediaWrap.classList.add('media');
      ui.mediaWrap.innerHTML = '<a href="'+url+'" target="_blank" rel="noopener" class="thumb-link">'
                             + '<img class="thumb img" src="'+url+'"></a>';
    },
    showVideo: function(ui,url,info){
      if(!ui||!ui.mediaWrap) return;
      ui.mediaWrap.classList.add('media');
      var bg = ui.poster ? ' style="background-image:url('+ui.poster+')"':'';
      ui.mediaWrap.innerHTML = '<a href="'+url+'" target="_blank" rel="noopener" class="thumb-link">'
                             + '<div class="thumb video"'+bg+'><div class="play">â–¶</div></div></a>'
                             + (info?'<div class="progress-line">'+info+'</div>':'');
    },
    showFileLink: function(ui,url,name,size){
      if(!ui||!ui.mediaWrap) return;
      var safe=String(name||'æ–‡ä»¶').replace(/"/g,'&quot;');
      ui.mediaWrap.classList.remove('media');
      ui.mediaWrap.innerHTML = '<a href="'+url+'" target="_blank" rel="noopener" class="file-link" title="'+safe+'">'
                             + '<div class="file-info"><span class="file-icon">ğŸ“„</span><span class="file-name">'+safe+'</span></div>'
                             + '<div class="progress-line">ä¸‹è½½ï¼š'+safe+' ('+human(size||0)+')</div></a>';
    },
    updateProgress: function(ui,p){ if(ui&&ui.progress) ui.progress.textContent = 'æ¥æ”¶ä¸­â€¦ '+p+'%'; },
    updateStatus: function(){
      if (statusChip) statusChip.textContent = app.isConnected ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
      if (onlineChip){
        var openCount=0; for (var k in app.conns){ if(app.conns[k].open) openCount++; }
        onlineChip.textContent = 'åœ¨çº¿ ' + openCount;
      }
      syncSendBtn();
    },
    getEditorText: textOfEditor,
    clearEditor: clearEditor,

    renderContacts: function(list, activeId){
      if (!contactList) return;
      var kw = (contactSearch && contactSearch.value || '').trim().toLowerCase();
      contactList.innerHTML='';
      var all=document.createElement('div'); all.className='contact'+((activeId==='all')?' active':''); all.dataset.id='all';
      all.innerHTML='<div class="avatar"></div><div><div class="cname">æ‰€æœ‰äººï¼ˆç¾¤èŠï¼‰</div><div class="cmsg">ç¾¤èŠ</div></div>';
      all.addEventListener('click', function(){
        app.activePeer='all';
        contactList.querySelectorAll('.contact.active').forEach(function(el){ el.classList.remove('active'); });
        all.classList.add('active');
      });
      contactList.appendChild(all);

      for (var pid in app.conns){
        if (!app.conns.hasOwnProperty(pid)) continue;
        if (!app.conns[pid].open) continue;
        var nm = app.displayNames[pid] || ('èŠ‚ç‚¹ '+pid.substring(0,8));
        if (kw && nm.toLowerCase().indexOf(kw)===-1) continue;
        var row=document.createElement('div'); row.className='contact'+((activeId===pid)?' active':''); row.dataset.id=pid;
        row.innerHTML='<div class="avatar"></div><div><div class="cname"></div><div class="cmsg">åœ¨çº¿</div></div>';
        row.querySelector('.cname').textContent = nm;
        row.addEventListener('click', function(){
          app.activePeer = this.dataset.id;
          contactList.querySelectorAll('.contact.active').forEach(function(el){ el.classList.remove('active'); });
          this.classList.add('active');
        });
        contactList.appendChild(row);
      }
      fixAllLabel();
    }
  };

  if (editor){
    editor.addEventListener('input', syncSendBtn);
    var composing=false;
    editor.addEventListener('compositionstart', function(){ composing=true; });
    editor.addEventListener('compositionend', function(){ composing=false; });
    editor.addEventListener('keydown', function(e){
      if (e.key==='Enter' && !e.shiftKey && !composing){ e.preventDefault(); app.sendMsg(); }
    });
  }
  var emojiBtn=document.getElementById('emojiBtn');
  if (emojiBtn && editor){
    emojiBtn.addEventListener('click', function(){
      editor.focus();
      try{ document.execCommand('insertText', false, 'ğŸ˜€'); }catch(e){
        var r=document.createRange(); r.selectNodeContents(editor); r.collapse(false);
        var s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
        var node=document.createTextNode('ğŸ˜€'); r.insertNode(node);
      }
      syncSendBtn();
    });
  }
  if (sendBtn){ sendBtn.addEventListener('click', function(){ app.sendMsg(); }); }
  if (fileInput){ fileInput.addEventListener('change', function(e){ var files=[].slice.call(e.target.files||[]); if(files.length) app.sendFilesFrom(files); e.target.value=''; }); }

  if (sendArea){
    function onDragEnter(e){ e.preventDefault(); sendArea.classList.add('drag-over'); }
    function onDragOver(e){ e.preventDefault(); }
    function onDragLeave(e){ e.preventDefault(); if(e.target===sendArea || !sendArea.contains(e.relatedTarget)) sendArea.classList.remove('drag-over'); }
    function onDrop(e){ e.preventDefault(); sendArea.classList.remove('drag-over'); var files=[].slice.call((e.dataTransfer&&e.dataTransfer.files)||[]); if(files.length) app.sendFilesFrom(files); }
    sendArea.addEventListener('dragenter', onDragEnter);
    sendArea.addEventListener('dragover', onDragOver);
    sendArea.addEventListener('dragleave', onDragLeave);
    sendArea.addEventListener('drop', onDrop);
  }

  if (contactSearch){ contactSearch.addEventListener('input', function(){
    var arr=[]; for (var k in app.conns){ if(app.conns[k].open) arr.push({id:k,name: app.displayNames[k]||('èŠ‚ç‚¹ '+k.substring(0,8))}); }
    app._classic.renderContacts(arr, app.activePeer);
  }); }

  (function initialRender(){
    if (!contactList || !app || !app._classic || !app._classic.renderContacts) return;
    var arr = [];
    for (var pid in app.conns) {
      if (!app.conns.hasOwnProperty(pid)) continue;
      if (!app.conns[pid].open) continue;
      arr.push({ id: pid, name: app.displayNames[pid] || ('èŠ‚ç‚¹ ' + pid.substring(0,8)) });
    }
    app._classic.renderContacts(arr, app.activePeer);
  })();

  app._classic.updateStatus();
}

// å…³é”®ä¿®å¤ï¼šclassic é¡µé¢å¤ç”¨ opener.appï¼ˆå«æœ€å¤š 1 ç§’é‡è¯•ï¼Œæœç»æ—¶åºç«æ€ï¼‰
if (window.CLASSIC_UI && window.opener) {  // âœ… è¿™é‡Œä¹ŸåŒ¹é…äº†
  (function tryReuse(i){
    if (window.opener.app) {
      window.app = window.opener.app;
      bindClassicUI(window.app);
    } else if (i < 10) {
      setTimeout(function(){ tryReuse(i+1); }, 100);
    } else {
      window.app = app;
      bindClassicUI(app);
    }
  })(0);
} else {
  window.app = app;
  if (window.CLASSIC_UI) bindClassicUI(app);  // âœ… è¿™é‡Œä¹ŸåŒ¹é…äº†
}
})();
```

---

## ğŸ“„ index.htmlï¼ˆå…¥å£é¡µï¼Œä¿æŒä¸å˜ï¼‰

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>P2P å›ºå®šå…¥å£ï¼ˆè¿æ¥é…ç½®ï¼‰</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,'Noto Sans','PingFang SC','Microsoft YaHei',sans-serif;background:#0f1115;color:#e6e6e6}
    .wrap{max-width:820px;margin:30px auto;padding:16px}
    .card{border:1px solid #232634;border-radius:12px;padding:16px;background:#0b0d12}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .row input[type=text]{flex:1;min-width:180px;padding:10px;border:1px solid #2b3040;border-radius:8px;background:#0f1320;color:#d7e1f2}
    .btn{padding:10px 14px;border:1px solid #3a4660;border-radius:8px;background:#2a7cff;color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1a2234;color:#d7e1f2}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{padding:4px 10px;border-radius:999px;border:1px solid #2a3142;background:#0e1422;color:#a9c6ff;font-size:12px}
    .box{border:1px solid #232634;border-radius:10px;padding:12px;background:#0a0c10;margin-top:12px}
    .muted{color:#9aa7b4;font-size:12px}
    .log{margin-top:12px;background:#0a0c10;border:1px solid #232634;border-radius:10px;padding:10px;height:220px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;color:#9fe3a6}
    .vid{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    video{max-width:380px;background:#000;border-radius:8px}
    .qr{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .qr-wrap{display:inline-block;background:#ffffff;padding:16px;border-radius:10px;border:1px solid #e5e5e5}
    #qr{width:256px;height:256px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ğŸš€ å›ºå®šå…¥å£ Â· P2P è¿æ¥é…ç½®</h1>
      <div class="muted">å…¥å£å›ºå®šï¼›èŠå¤© UI ä½¿ç”¨åŸç‰ˆæ ·å¼ï¼ˆclassic.htmlï¼‰ï¼Œæ— éœ€ä¿®æ”¹ã€‚</div>

      <div class="row">
        <input id="networkName" type="text" value="public-network" placeholder="ç½‘ç»œåç§°ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰" />
        <input id="nickname" type="text" placeholder="ä½ çš„æ˜µç§°ï¼ˆå¯ç•™ç©ºéšæœºï¼‰" />
        <button id="connectBtn" class="btn">ğŸ”Œ è¿æ¥ç½‘ç»œ</button>
        <button class="btn secondary" id="openUI">æ‰“å¼€èŠå¤© UI</button>
      </div>

      <div class="chips">
        <span class="chip">æœ¬åœ° IDï¼š<b id="localId">-</b></span>
        <span class="chip">è™šæ‹Ÿ IPï¼š<b id="virtualIp">-</b></span>
        <span class="chip">åœ¨çº¿èŠ‚ç‚¹ï¼š<b id="peerCount">0</b></span>
        <span class="chip">è¿è¡Œæ—¶é•¿ï¼š<b id="uptime">00:00:00</b></span>
        <span class="chip" id="statusChip">çŠ¶æ€ï¼šç¦»çº¿</span>
      </div>

      <div id="share" class="box" style="display:none">
        <div class="row" style="margin:0">
          <input id="shareLink" readonly />
          <button class="btn" id="copyShare">å¤åˆ¶é‚€è¯·é“¾æ¥</button>
        </div>
        <div class="qr">
          <div id="qrBox" class="qr-wrap"><div id="qr"></div></div>
          <div class="muted">ç”¨å¯¹æ–¹è®¾å¤‡"æµè§ˆå™¨æ‰«ç /ç›¸æœºæ‰«ç "æ‰“å¼€ï¼›æ‰“å¼€åä¹Ÿç‚¹å‡»"è¿æ¥ç½‘ç»œ"ã€‚</div>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="callBtn" class="btn secondary" disabled>ğŸ¥ å‘èµ·/ç»“æŸè§†é¢‘é€šè¯ï¼ˆå½“å‰å•èŠï¼‰</button>
      </div>
      <div class="vid">
        <div>
          <div class="chip">æˆ‘</div>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div>
          <div class="chip">å¯¹æ–¹</div>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="copyLog">å¤åˆ¶å…¨éƒ¨æ—¥å¿—</button>
        <button class="btn secondary" id="clearLog">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div id="log" class="log">> å°±ç»ªï¼šç‚¹å‡»"è¿æ¥ç½‘ç»œ"å¼€å§‹</div>

      <div class="muted" style="margin-top:8px">
        è¯´æ˜ï¼šè‹¥å°‘æ•°ç½‘ç»œæ— æ³•ç›´è¿ï¼Œè§†é¢‘é€šè¯å¯èƒ½å¤±è´¥ï¼ˆä¸å¼ºæ±‚ï¼‰ã€‚æ–‡ä»¶ï¼šå›¾ç‰‡å³æ˜¾ï¼›è§†é¢‘å…ˆæ˜¾ç¤ºå°é¢ï¼Œæ•°æ®è¶³å¤Ÿåå¯æ’­æ”¾ã€‚
      </div>
    </div>
  </div>

  <script>
    window.__FIXED_SERVER__  = { host:'peerjs.92k.de', port:443, secure:true, path:'/' };
    window.__FIXED_NETWORK__ = 'public-network';
    window.__ENTRY_PAGE__    = true;
  </script>
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.0/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs@0.0.2/qrcode.min.js"></script>
  <script src="easytier.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const logEl = $('#log');
    function log(s){ logEl.textContent += (logEl.textContent ? '\n' : '') + s; logEl.scrollTop = logEl.scrollHeight; }
    window._entryLog = log;

    document.addEventListener('DOMContentLoaded', function(){
      const connectBtn = $('#connectBtn');
      const openUI     = $('#openUI');
      const copyShare  = $('#copyShare');
      const copyLogBtn = $('#copyLog');
      const clearLogBtn= $('#clearLog');
      const callBtn    = $('#callBtn');
      const nickIpt    = $('#nickname');

      const savedNick = localStorage.getItem('nickname') || '';
      if (savedNick) nickIpt.value = savedNick;

      connectBtn.addEventListener('click', ()=>{
        localStorage.setItem('nickname', (nickIpt.value||'').trim());
        if (window.app) app.toggle();
      });
      openUI.addEventListener('click', ()=> window.open('classic.html','_blank'));
      copyShare.addEventListener('click', ()=> window.app && app.copyLink());
      copyLogBtn.addEventListener('click', ()=> window.app && app.copyLog());
      clearLogBtn.addEventListener('click', ()=> window.app && app.clearLog());
      callBtn.addEventListener('click', ()=> window.app && app.toggleCall());

      window.updateEntryStatus = function(state){
        $('#statusChip').textContent = 'çŠ¶æ€ï¼š' + (state.connected ? 'åœ¨çº¿' : 'ç¦»çº¿');
        $('#peerCount').textContent = String(state.online||0);
        $('#localId').textContent   = state.localId || '-';
        $('#virtualIp').textContent = state.virtualIp || '-';
        $('#uptime').textContent    = state.uptime || '00:00:00';
        $('#share').style.display   = state.connected ? 'block' : 'none';
        $('#callBtn').disabled      = !state.connected;
        connectBtn.textContent      = state.connected ? 'ğŸ”Œ æ–­å¼€' : 'ğŸ”Œ è¿æ¥ç½‘ç»œ';
      };

      if (window.app && !app.isConnected) app.toggle();
    });

    window.addEventListener('beforeunload', function(e){
      if (window.app && app.isConnected) {
        e.preventDefault();
        e.returnValue = 'å…³é—­é¡µé¢å°†æ–­å¼€è¿æ¥ï¼Œç¡®å®šå—ï¼Ÿ';
      }
    });
  </script>
</body>
</html>